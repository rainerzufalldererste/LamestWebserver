using System;

namespace LamestWebserver.UI
{
    /// <summary>
    /// Contains some default JavaScript functions.
    /// </summary>
    public static class ScriptCollection
    {
        /// <summary>
        /// A prototype for a script-function code piece.
        /// </summary>
        /// <param name="sessionData">the current sessionData</param>
        /// <param name="arguments">the arguments</param>
        public delegate string ScriptFuction(SessionData sessionData, object[] arguments);

        /// <summary>
        /// Reloads the current page in X milliseconds redirecting all HTTP-POST values to the new page. parameters: { int milliseconds }
        /// </summary>
        /// <inheritdoc />
        public static string GetPageReloadWithFullPostInMilliseconds(SessionData sessionData, object[] millisecondsAsInt)
        {
            if (millisecondsAsInt.Length != 1)
                throw new ArgumentException("the argument has to be an object[1] containing one integer number");

            if ((SessionContainer.SessionIdTransmissionType == SessionContainer.ESessionIdTransmissionType.Cookie &&
                 (!(sessionData is HttpSessionData) || sessionData.HttpPostVariables.Count == 0)) || sessionData == null || string.IsNullOrWhiteSpace(sessionData.Ssid))
                return "setTimeout(function() { window.location = window.location; }," + int.Parse(millisecondsAsInt[0].ToString()) + ");";

            string ret =
                "setTimeout(function(){var f=document.createElement('form');f.setAttribute('method','POST');f.setAttribute('action',window.location);f.setAttribute('enctype','application/x-www-form-urlencoded');var i;";

            if (sessionData is HttpSessionData)
            {
                foreach (var variable in sessionData.HttpPostVariables)
                {
                    ret += "i=document.createElement('input');i.setAttribute('type','hidden');i.setAttribute('name','"
                           + variable.Key.Replace("\n", "\\n") + "');i.setAttribute('value','"
                           + variable.Value.Replace("\n", "\\n") + "');f.appendChild(i);";
                }
            }

            ret += "document.body.appendChild(f);f.submit();document.body.remove(f);}, " + int.Parse(millisecondsAsInt[0].ToString()) + ");";

            return ret;
        }

        /// <summary>
        /// Reloads the current page in X milliseconds. parameters: { int milliseconds }
        /// </summary>
        /// <param name="sessionData">the current sessionData</param>
        /// <param name="arguments">the arguments</param>
        public static string GetPageReloadInMilliseconds(SessionData sessionData, object[] arguments)
        {
            if (arguments.Length != 1)
                throw new ArgumentException("the argument has to be an object[1] containing one integer number");

            if (SessionContainer.SessionIdTransmissionType == SessionContainer.ESessionIdTransmissionType.Cookie || sessionData == null ||
                string.IsNullOrWhiteSpace(sessionData.Ssid))
                return "setTimeout(function() { window.location = window.location; }," + int.Parse(arguments[0].ToString()) + ");";

            string ret = "setTimeout(function(){var f=document.createElement('form');f.setAttribute('method','POST');f.setAttribute('action',window.location);f.setAttribute('enctype','application/x-www-form-urlencoded');var i=document.createElement('input');i.setAttribute('type','hidden');i.setAttribute('name','ssid');i.setAttribute('value','"
                         + sessionData.Ssid + "');f.appendChild(i);document.body.appendChild(f);f.submit();document.body.remove(f);}, "
                         + int.Parse(arguments[0].ToString()) + ");";

            return ret;
        }

        /// <summary>
        /// Redirects to the page X in Y milliseconds. parameters: { string newPageUrl, int milliseconds }
        /// </summary>
        /// <param name="sessionData">the current sessionData</param>
        /// <param name="arguments">the arguments</param>
        public static string GetPageReferalToXInMilliseconds(SessionData sessionData, object[] arguments)
        {
            if (arguments.Length != 2)
                throw new ArgumentException("the argument has to be an object[2] containing one string and one integer number");

            if (SessionContainer.SessionIdTransmissionType == SessionContainer.ESessionIdTransmissionType.Cookie || sessionData == null ||
                string.IsNullOrWhiteSpace(sessionData.Ssid))
                return "setTimeout(function() { window.location = '" + arguments[0] + "'; }," + int.Parse(arguments[1].ToString()) + ");";

            string ret = "setTimeout(function(){var f=document.createElement('form');f.setAttribute('method','POST');f.setAttribute('action','"
                         + arguments[0] +
                         "');f.setAttribute('enctype','application/x-www-form-urlencoded');var i=document.createElement('input');i.setAttribute('type','hidden');i.setAttribute('name','ssid');i.setAttribute('value','"
                         + sessionData.Ssid + "');f.appendChild(i);document.body.appendChild(f);f.submit();document.body.remove(f);}, "
                         + int.Parse(arguments[1].ToString()) + ");";

            return ret;
        }

        /// <summary>
        /// Redirects to the page X . parameters: { string newPageUrl }
        /// </summary>
        /// <param name="sessionData">the current sessionData</param>
        /// <param name="arguments">the arguments</param>
        public static string GetPageReferalToX(SessionData sessionData, object[] arguments)
        {
            if (arguments.Length != 1)
                throw new ArgumentException("the argument has to be an object[1] containing one string");

            if (SessionContainer.SessionIdTransmissionType == SessionContainer.ESessionIdTransmissionType.Cookie || sessionData == null ||
                string.IsNullOrWhiteSpace(sessionData.Ssid))
                return "window.location = '" + arguments[0] + "';";

            string ret = "onload = function() {var f=document.createElement('form');f.setAttribute('method','POST');f.setAttribute('action','"
                         + arguments[0] +
                         "');f.setAttribute('enctype','application/x-www-form-urlencoded');var i=document.createElement('input');i.setAttribute('type','hidden');i.setAttribute('name','ssid');i.setAttribute('value','"
                         + sessionData.Ssid + "');f.appendChild(i);document.body.appendChild(f);f.submit();document.body.remove(f);};";

            return ret;
        }

        /// <summary>
        /// Redirects to the page X in Y milliseconds redirecting all HTTP-POST values to the new page. parameters: { string newPageUrl, int milliseconds }
        /// </summary>
        /// <param name="sessionData">the current sessionData</param>
        /// <param name="arguments">the arguments</param>
        public static string GetPageReferalWithFullPostInMilliseconds(SessionData sessionData, object[] arguments)
        {
            if (arguments.Length != 2)
                throw new ArgumentException("the argument has to be an object[2] containing one string and one integer number");

            if ((SessionContainer.SessionIdTransmissionType == SessionContainer.ESessionIdTransmissionType.Cookie &&
                 (!(sessionData is HttpSessionData) || sessionData.HttpPostVariables.Count == 0)) || sessionData == null || string.IsNullOrWhiteSpace(sessionData.Ssid))
                return "onload = setTimeout(function() { window.location = '" + arguments[0] + "'; }," + int.Parse(arguments[1].ToString()) + ");";

            string ret = "onload = setTimeout(function(){var f=document.createElement('form');f.setAttribute('method','POST');f.setAttribute('action','"
                         + arguments[0]
                         + "');f.setAttribute('enctype','application/x-www-form-urlencoded');var i;";

            if (sessionData is HttpSessionData)
            {
                foreach (var variable in sessionData.HttpPostVariables)
                {
                    ret += "i=document.createElement('input');i.setAttribute('type','hidden');i.setAttribute('name','"
                           + variable.Key.Replace("\n", "\\n") + "');i.setAttribute('value','"
                           + variable.Value.Replace("\n", "\\n") + "');f.appendChild(i);";
                }
            }

            ret += "document.body.appendChild(f);f.submit();document.body.remove(f);}, " + int.Parse(arguments[1].ToString()) + ");";

            return ret;
        }
    }
}
